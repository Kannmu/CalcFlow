# CalcFlow

## 本质
节点式动态计算器。将复杂计算拆分为可组合、可引用的计算节点，形成实时计算的依赖图。

## 核心价值
- **可视化计算逻辑**：表达式不再是黑盒，节点即变量，引用即依赖
- **即时反馈**：修改上游节点，下游自动重算（拓扑排序更新）
- **公式美学**：KaTeX实时渲染表达式=结果，数学即视图

## 架构
```
Vue3 + Vite
├── 表达式引擎：Tokenizer → Parser(Shunting-yard) → Evaluator(RPN)
├── 依赖系统：NodeManager维护双向依赖图，DFS检测循环依赖
├── 计算层：双引擎（mathjs兜底 + 自定义引擎）
└── 视图层：节点 → 元素 → 自动补全 + 语法高亮 + LaTeX
```

## 关键机制
| 机制 | 实现 |
|------|------|
| 依赖追踪 | `dependencyGraph` + `reverseDependencyGraph` 双向Map |
| 循环检测 | DFS遍历 `recursionStack` |
| 更新顺序 | 拓扑排序确保依赖先计算 |
| 表达式解析 | 自定义Shunting-yard算法，支持右结合幂运算 |
| 作用域解析 | 节点名→值映射，引用即变量 |

## 代码入口
- `src/utils.js:172` - NodeManager单例，所有节点/依赖操作中枢
- `src/math/expression-engine.js` - 词法/语法/求值/latex四阶段流水线
- `src/composables/useNodeCalculation.js` - 节点计算生命周期

## 未来形态
1. **可视化连线**：节点间SVG连线展示依赖关系（当前隐式）
2. **图布局**：力导向图自动排布节点（当前线性列表）
3. **多维输出**：矩阵/图表/数据流输出节点
4. **函数封装**：节点组打包为可复用函数
5. **协作**：CRDT实时协同编辑
6. **插件**：自定义函数/可视化组件热插拔
7. **历史**：计算步骤回放，类似git的表达式版本控制

## 哲学
计算应当像搭积木——简单组件组合出复杂系统，每一步可见、可改、可复用。

## 迭代闭环  
测试 ➜ 定位 ➜ 修复 ➜ 再测，飞轮不息。
